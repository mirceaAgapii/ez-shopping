pipeline {
    agent any

    tools {
        maven "Maven 3.8.1"
    }

    environment {
      def dockerImage = null;
    }

    stages {
        stage("Read from Maven POM"){
            steps{
                script{
                    pom = readMavenPom file: 'backend/pom.xml'
                    projectArtifactId = pom.artifactId
                    projectVersion = pom.version
                }
                echo 'Building ${projectArtifactId}:${projectVersion}'
            }
        }
        stage("Test"){
            steps {
                sh 'mvn -version'
               // bat "mvn test"
            }
        }
        stage("Build JAR file"){
            steps{
                sh 'mvn install -f backend/pom.xml -Dmaven.test.skip=true'
            }
        }
        stage("Build docker image"){
            steps {
               echo "Building backend docker image "

               sh ('docker build -t backend:v1.0 -f backend/pipelines/Dockerfile .')
            }
        }
         stage('DigitalOcean Login') {
           steps {
             sh ('echo docker login -u $DO_TOKEN -p $DO_TOKEN registry.digitalocean.com/ezshopping')
           }
         }
         stage("Pushing backend image to DigitalOcean"){
             steps {
                 echo "Pushing backend image to DigitalOcean container registry"
                 sh ('docker tag backend:v1.0 registry.digitalocean.com/ezshopping/backend')
                 sh ('docker push registry.digitalocean.com/ezshopping/backend')
             }
         }
        stage("Deploy"){
            steps{
                echo 'Server is fully up and running'

            }
        }
    }
    post {
        always {
            cleanWs()
            sh 'docker logout'
        }
    }
}